<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Anchor Draggers - DIY Baltic Corridor Watch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <meta name="description" content="Real-time AIS vessel tracking for Baltic Sea cable monitoring"/>
  <meta name="theme-color" content="#00eaff"/>
  <meta name="app-version" content="1.31"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Anchor Draggers"/>
  <link rel="manifest" href="./manifest.json"/>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"/>
  <link rel="stylesheet" href="css/styles.css"/>
  <link rel="icon" href="data:,">
</head>
<body>
  <div class="logo-header">
    <svg width="180" height="180" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" class="logo-icon">
      <circle cx="90" cy="90" r="78" fill="none" stroke="#00eaff" stroke-width="6" opacity="0.8"/>
      <circle cx="90" cy="90" r="55" fill="none" stroke="#00eaff" stroke-width="3" opacity="0.5"/>
      <line x1="90" y1="12"  x2="90" y2="24"  stroke="#00eaff" stroke-width="3" opacity="0.8"/>
      <line x1="156" y1="90" x2="144" y2="90" stroke="#00eaff" stroke-width="3" opacity="0.8"/>
      <line x1="90" y1="156" x2="90" y2="144" stroke="#00eaff" stroke-width="3" opacity="0.8"/>
      <line x1="12" y1="90"  x2="24" y2="90"  stroke="#00eaff" stroke-width="3" opacity="0.8"/>
      <line x1="133" y1="32" x2="125" y2="40" stroke="#00eaff" stroke-width="1.8" opacity="0.6"/>
      <line x1="148" y1="133" x2="138" y2="125" stroke="#00eaff" stroke-width="1.8" opacity="0.6"/>
      <line x1="32" y1="133" x2="40" y2="125" stroke="#00eaff" stroke-width="1.8" opacity="0.6"/>
      <line x1="48" y1="32"  x2="56" y2="40"  stroke="#00eaff" stroke-width="1.8" opacity="0.6"/>
      <text x="90" y="20" text-anchor="middle" fill="#00eaff" font-size="12" font-weight="bold">N</text>
      <text x="154" y="94" text-anchor="middle" fill="#00eaff" font-size="12" font-weight="bold">E</text>
      <text x="90" y="160" text-anchor="middle" fill="#00eaff" font-size="12" font-weight="bold">S</text>
      <text x="26" y="94" text-anchor="middle" fill="#00eaff" font-size="12" font-weight="bold">W</text>
      <g id="radar-sweep">
        <path d="M90 90 L90 35 A55 55 0 0 1 145 90 Z"
              fill="#00eaff"
              opacity="0.5">
        </path>
      </g>
      <polygon points="90,18 100,40 80,40" fill="#00eaff" opacity="0.95"/>
      <line x1="90" y1="60" x2="90" y2="120" stroke="#00eaff" stroke-width="5" stroke-linecap="round"/>
      <circle cx="90" cy="50" r="9" fill="none" stroke="#00eaff" stroke-width="4"/>
      <line x1="72" y1="78" x2="108" y2="78" stroke="#00eaff" stroke-width="4" stroke-linecap="round"/>
      <path d="M50 115 Q90 150 130 115" fill="none" stroke="#00eaff" stroke-width="5" stroke-linecap="round"/>
      <path d="M50 115 Q45 130 60 132" stroke="#00eaff" stroke-width="5" fill="none" stroke-linecap="round"/>
      <path d="M130 115 Q135 130 120 132" stroke="#00eaff" stroke-width="5" fill="none" stroke-linecap="round"/>
    </svg>
    <div class="logo-text">
      <h1 class="logo-title">ANCHOR DRAGGERS</h1>
      <h2 class="logo-subtitle">DIY BALTIC CORRIDOR WATCH</h2>
      <div class="version">v1.31</div>
    </div>
  </div>

  <!-- Install App Button -->
  <button id="install-button" class="install-button" style="display: none;" title="Install App">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
  </button>

  <!-- Install Banner -->
  <div id="install-banner" class="install-banner" style="display: none;">
    <div class="install-banner-content">
      <span class="install-banner-icon">ðŸ“²</span>
      <div class="install-banner-text">
        <strong>Install Anchor Draggers</strong>
        <small>Fast access â€¢ Works offline â€¢ Full screen</small>
      </div>
      <button id="install-banner-button" class="install-banner-action">Install</button>
      <button id="install-banner-close" class="install-banner-close">âœ•</button>
    </div>
  </div>

  <div id="map"></div>
  <div class="sky-overlay"></div>
  <div class="ground-vignette"></div>
  
  <div id="stats-panel" class="stats-panel stats-panel-collapsed">
    <div id="stats-header" class="stats-header" tabindex="0">
      <span class="stats-header-title">Status | Flag | Route</span>
      <button id="clear-filter" class="clear-filter-btn" style="display: none;" title="Clear all filters">âœ•</button>
      <span id="stats-panel-arrow">&#x25B2;</span>
    </div>
    <div id="stats-content" class="stats-body">
      Initializingâ€¦
    </div>
  </div>
  <div class="attribution">
    AIS data Â© Digitraffic, Maps Â© CARTO + OpenStreetMap, <a href="#" id="license-more" class="license-link">more...</a>
  </div>
  <div id="license-modal" class="license-modal" style="display: none;">
    <div class="license-modal-content">
      <span class="license-close">&times;</span>
      <h3>Data Sources & Licenses</h3>
      <div class="license-section">
        <strong>AIS Data:</strong><br>
        Â© <a href="https://www.fintraffic.fi/en/fintraffic/digitraffic" target="_blank" rel="noopener">Fintraffic / Digitraffic</a><br>
        License: <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>
      </div>
      <div class="license-section">
        <strong>Map Tiles:</strong><br>
        Â© <a href="https://carto.com/attribution" target="_blank" rel="noopener">CARTO</a><br>
        Data Â© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap contributors</a>
      </div>
      <div class="license-section">
        <strong>Maritime Boundaries:</strong><br>
        Â© <a href="https://helcom.fi" target="_blank" rel="noopener">HELCOM</a> (Territorial Waters dataset)<br>
        Sources: <a href="https://www.eea.europa.eu" target="_blank" rel="noopener">European Environment Agency</a>, 
        <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a>, 
        <a href="https://www.sjofartsverket.se" target="_blank" rel="noopener">Swedish Maritime Administration</a>
      </div>
      <div class="license-section">
        <strong>Map Library:</strong><br>
        Â© <a href="https://maplibre.org" target="_blank" rel="noopener">MapLibre GL JS</a><br>
        License: BSD-3-Clause
      </div>
      <div class="license-section">
        <strong>UN/LOCODE Data:</strong><br>
        Â© United Nations / <a href="https://github.com/datasets/un-locode" target="_blank" rel="noopener">datasets/un-locode</a><br>
        License: ODC PDDL
      </div>
      <div class="license-section">
        <strong>Flag Images:</strong><br>
        Â© <a href="https://flagpedia.net" target="_blank" rel="noopener">Flagpedia.net</a> via <a href="https://flagcdn.com" target="_blank" rel="noopener">flagcdn.com</a><br>
        Sources: Wikipedia Commons
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script type="module" src="js/app.js"></script>
  <script>
    // PWA Install Prompt
    let deferredPrompt;
    const installButton = document.getElementById('install-button');
    const installBanner = document.getElementById('install-banner');
    const installBannerButton = document.getElementById('install-banner-button');
    const installBannerClose = document.getElementById('install-banner-close');

    // Check if already installed or running as PWA
    const isInstalled = window.matchMedia('(display-mode: standalone)').matches;

    // Capture the beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button
      installButton.style.display = 'flex';
      
      // Show banner if not dismissed before and not installed
      const bannerDismissed = localStorage.getItem('installBannerDismissed');
      if (!bannerDismissed && !isInstalled) {
        setTimeout(() => {
          installBanner.style.display = 'block';
        }, 3000); // Show after 3 seconds
      }
    });

    // Install button click
    installButton.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('App installed');
      }
      
      deferredPrompt = null;
      installButton.style.display = 'none';
      installBanner.style.display = 'none';
    });

    // Banner install button click
    installBannerButton.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('App installed');
      }
      
      deferredPrompt = null;
      installButton.style.display = 'none';
      installBanner.style.display = 'none';
    });

    // Close banner
    installBannerClose.addEventListener('click', () => {
      installBanner.style.display = 'none';
      localStorage.setItem('installBannerDismissed', 'true');
    });

    // Register service worker for PWA with version from meta tag
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const version = document.querySelector('meta[name="app-version"]')?.content || '1.29';
        navigator.serviceWorker.register('./service-worker.js?v=' + version)
          .then(reg => {
            console.log('Service Worker registered:', reg.scope);
            // Check for updates
            reg.update();
          })
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
